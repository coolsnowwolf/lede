# =================================================
# OpenWrt x86 è™šæ‹Ÿæœºä¸“ç”¨ç¼–è¯‘é…ç½®æ–‡ä»¶
# åŠŸèƒ½ï¼šè‡ªåŠ¨ä¿®å¤ä¾èµ–/ç¼“å­˜åŠ é€Ÿ/é”™è¯¯æ—¥å¿—æ”¶é›†
# æ›´æ–°æ—¥æœŸï¼š2024-04-20
# =================================================

name: OpenWrt x86 Build

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ master ] # ä»£ç æ¨é€è§¦å‘

env:
  CCACHE_DIR: /tmp/ccache  # ç¼“å­˜ç›®å½•
  TARGET: x86              # ç›®æ ‡æ¶æ„
  SUBTARGET: 64            # å­æ¶æ„
  FIRMWARE_DIR: lede/bin/targets/x86/64  # å›ºå®šè·¯å¾„ï¼Œé¿å…å˜é‡åµŒå¥—é—®é¢˜

jobs:
  build:
    runs-on: ubuntu-22.04  # å¿…é¡»ä½¿ç”¨ 22.04 ç³»ç»Ÿ
    timeout-minutes: 240   # è¶…æ—¶æ—¶é—´ï¼ˆ4å°æ—¶ï¼‰

    steps:
    # ---------------------- é˜¶æ®µ1ï¼šæºç åˆå§‹åŒ– ----------------------
    - name: ğŸ”„ æ‹‰å–æºç 
      uses: actions/checkout@v4
      with:
        path: lede  # è¿™æ · `lede` ç›®å½•ä¸ä¼šåµŒå¥—
        submodules: recursive  # é€’å½’å…‹éš†å­æ¨¡å—
        fetch-depth: 0         # åŠ é€Ÿå…‹éš†

    # ---------------------- é˜¶æ®µ2ï¼šç¼“å­˜ç®¡ç† ----------------------
    - name: ğŸ“¦ åŠ è½½ç¼“å­˜
      uses: actions/cache@v3
      id: cache
      with:
        path: |
          ${{ env.CCACHE_DIR }}
          lede/dl
          lede/build_dir
        key: ${{ runner.os }}-x86-64-${{ hashFiles('lede/.config') }}-v3  # ç‰ˆæœ¬æ ‡è¯†

    # ---------------------- é˜¶æ®µ3ï¼šå®‰è£…ç³»ç»Ÿä¾èµ– ----------------------
    - name: ğŸ“¦ å®‰è£…ç¼–è¯‘å·¥å…·
      run: |
        sudo apt-get update -y
        # å®‰è£…æ‰€æœ‰å¿…è¦ä¾èµ–ï¼ˆåŒ…å«ç»ˆç«¯ä¿®å¤åŒ…ï¼‰
        sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3 python3-pip rsync unzip zlib1g-dev \
          libelf-dev liblzma-dev lib32z1-dev pkg-config autoconf ncurses-term ncurses-base

        # ä¿®å¤ç»ˆç«¯ç¯å¢ƒå˜é‡
        echo "TERM=linux" >> $GITHUB_ENV
        echo "TERMINFO=/usr/share/terminfo" >> $GITHUB_ENV

    # ---------------------- é˜¶æ®µ4ï¼šç¡®ä¿è„šæœ¬åœ¨æ­£ç¡®ç›®å½• ----------------------
    - name: ğŸ› ï¸ å¤åˆ¶è‡ªå®šä¹‰è„šæœ¬åˆ° lede ç›®å½•
      run: |
        ls
        find .
        pwd
        
        cp diy-part1.sh $GITHUB_WORKSPACE/lede/
        cp github.workspace/diy-part2.sh $GITHUB_WORKSPACE/lede/

    # ---------------------- é˜¶æ®µ5ï¼šæ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ ----------------------
    - name: ğŸ› ï¸ æ‰§è¡Œ diy-part1.sh
      run: |
        cd lede
        chmod +x diy-part1.sh
        ./diy-part1.sh

    # ---------------------- é˜¶æ®µ6ï¼šç”Ÿæˆç¼–è¯‘é…ç½® ----------------------
    - name: âš™ï¸ ç”Ÿæˆé…ç½®
      run: |
        cd lede
        # åˆå¹¶æ—§é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        [ -f .config ] && cp .config .config.bak || true
        make defconfig

        # æ‰§è¡Œ diy-part2.sh
        chmod +x diy-part2.sh
        ./diy-part2.sh

        # è‡ªåŠ¨ä¿®å¤å¸¸è§ç¼ºå¤±ä¾èµ–
        REQUIRED_DEPS=(
          "CONFIG_PACKAGE_lm-sensors=y"
          "CONFIG_PACKAGE_wsdd2=y"
          "CONFIG_PACKAGE_bc=y"
          "CONFIG_PACKAGE_libpam=y"
          "CONFIG_PACKAGE_luci-base=y"
        )
        for dep in "${REQUIRED_DEPS[@]}"; do
          grep -q "$dep" .config || echo "$dep" >> .config
        done

        # å¯ç”¨ ccache åŠ é€Ÿ
        echo "CONFIG_CCACHE=y" >> .config
        echo "CONFIG_CCACHE_DIR=\"$CCACHE_DIR\"" >> .config

    # ---------------------- é˜¶æ®µ7ï¼šæ ¸å¿ƒç¼–è¯‘ ----------------------
    - name: ğŸ”¨ å¼€å§‹ç¼–è¯‘
      run: |
        cd lede
        # åŠ¨æ€çº¿ç¨‹æ§åˆ¶ï¼ˆé˜²æ­¢OOMï¼‰
        MAX_CORES=$(nproc)
        SAFE_CORES=$(( MAX_CORES > 4 ? 4 : MAX_CORES ))

        # å¼ºåˆ¶è®°å½•å®Œæ•´æ—¥å¿—
        mkdir -p tmp/work/logs
        set -o pipefail
        time make -j$SAFE_CORES V=sc 2>&1 | tee build.log tmp/work/logs/full.log

        # éªŒè¯å›ºä»¶å­˜åœ¨æ€§
        [ -f $FIRMWARE_DIR/*.img ] || (echo "âŒ å›ºä»¶æœªç”Ÿæˆ"; exit 1)

    # ---------------------- é˜¶æ®µ8ï¼šäº§ç‰©å¤„ç† ----------------------
    - name: ğŸ“¦ æ‰“åŒ…è¾“å‡º
      run: |
        cd lede
        RELEASE_NAME="openwrt_x86_$(date +'%Y%m%d_%H%M')"
        mkdir -p $RELEASE_NAME
        cp $FIRMWARE_DIR/*.{img,sha256sum} $RELEASE_NAME/
        cp build.log $RELEASE_NAME/
        tar -czvf $RELEASE_NAME.tar.gz $RELEASE_NAME

    - name: â¬†ï¸ ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-x86
        path: "lede/*.tar.gz"
        retention-days: 7

    # ---------------------- é˜¶æ®µ9ï¼šé”™è¯¯å¤„ç† ----------------------
    - name: ğŸš¨ ä¸Šä¼ é”™è¯¯æ—¥å¿—
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs
        path: |
          lede/build.log
          lede/tmp/work/logs/*.log
