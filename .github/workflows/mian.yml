name: ğŸš€ Nokia EA0326GMP æé€Ÿç¼–è¯‘ (ä¿®å¤ç‰ˆ)

on:
  push:
    tags: ['v*']
  workflow_dispatch:

env:
  FIRMWARE_PATH: bin/targets/mediatek/filogic/
  CCACHE_DIR: /tmp/ccache
  DL_DIR: /tmp/dl
  BUILD_DIR: /tmp/build_dir

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    # ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ–ç¯å¢ƒ
    - name: ğŸ” æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: ğŸ› ï¸ è®¾ç½®ç¼“å­˜ç›®å½•
      run: |
        mkdir -p $CCACHE_DIR $DL_DIR $BUILD_DIR
        sudo chown -R $USER:$USER $CCACHE_DIR $DL_DIR $BUILD_DIR
        ccache -M 4G
        echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV

    - name: ğŸ“¦ å®‰è£…åŸºç¡€å·¥å…·é“¾
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential ccache clang flex bison g++ gawk gcc-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils \
          rsync unzip zlib1g-dev file wget cmake pkgconf

    - name: ğŸ’Š ä¿®å¤å…³é”®ä¾èµ–
      run: |
        sudo apt-get install -y \
          bc lm-sensors pciutils libpam-dev libcurl4-openssl-dev \
          libyaml-cpp-dev libaio-dev libpcre2-dev libselinux1-dev \
          libunistring-dev libxml2-dev libkmod-dev libtirpc-dev \
          libgpiod-dev glib2.0-dev jq zstd libzstd-dev

    # ç¬¬äºŒé˜¶æ®µï¼šå‡†å¤‡ç¼–è¯‘
    - name: ğŸ”§ é…ç½®ç¯å¢ƒ
      run: |
        export FORCE_UNSAFE_CONFIGURE=1
        export JOBS=$(($(nproc) + 1))
        echo "JOBS=$JOBS" >> $GITHUB_ENV

        # ä¿®å¤å·¥å…·é“¾é“¾æ¥
        mkdir -p staging_dir/host/bin
        ln -sf $(which gcc) staging_dir/host/bin/gcc || true
        ln -sf $(which g++) staging_dir/host/bin/g++ || true

    - name: â¬ ä¸‹è½½æºç 
      run: |
        make defconfig
        make download -j$JOBS
        find "$DL_DIR" -size -1k -delete

    # ç¬¬ä¸‰é˜¶æ®µï¼šåˆ†æ­¥ç¼–è¯‘
    - name: ğŸ› ï¸ ç¼–è¯‘å·¥å…·é“¾
      run: |
        make -j$JOBS tools/compile toolchain/compile || {
          echo "::warning::å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          make -j1 V=s tools/compile toolchain/compile
        }

    - name: ğŸ§± ç¼–è¯‘æ ¸å¿ƒåŒ…
      run: |
        make -j$JOBS package/compile || {
          echo "::warning::å¹¶è¡Œç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
          make -j1 V=s package/compile
        }

    - name: ğŸ–¼ï¸ ç”Ÿæˆå›ºä»¶
      run: |
        make -j$JOBS || make -j1 V=s

    # ç¬¬å››é˜¶æ®µï¼šå‘å¸ƒæˆæœ
    - name: ğŸ“Œ æ”¶é›†æˆæœ
      run: |
        mkdir -p artifacts
        cp $FIRMWARE_PATH/*.bin artifacts/
        cp $FIRMWARE_PATH/*.manifest artifacts/
        ccache -s > artifacts/ccache_stats.txt
        du -sh $CCACHE_DIR > artifacts/cache_size.txt

    - name: ğŸš€ åˆ›å»ºå‘å¸ƒç‰ˆ
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: "EA0326GMPå›ºä»¶ ${{ github.ref_name }}"
        body: |
          ### ğŸš© å›ºä»¶ä¿¡æ¯
          - è®¾å¤‡å‹å·ï¼šNokia EA0326GMP
          - ç¼–è¯‘æ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M')
          - æºç ç‰ˆæœ¬ï¼š$(git rev-parse --short HEAD)
          - CCACHEå‘½ä¸­ç‡ï¼š$(grep 'cache hit rate' artifacts/ccache_stats.txt | cut -d' ' -f4-)

          ### ğŸ”§ åˆ·æœºæŒ‡å—
          1. è¿›å…¥åŸå‚å›ºä»¶å‡çº§é¡µé¢
          2. é€‰æ‹©æœ¬å›ºä»¶æ–‡ä»¶
          3. ç­‰å¾…è‡ªåŠ¨é‡å¯ï¼ˆçº¦3åˆ†é’Ÿï¼‰

          ### âš ï¸ æ³¨æ„äº‹é¡¹
          - é¦–æ¬¡å¯åŠ¨è¾ƒæ…¢ï¼ˆçº¦5åˆ†é’Ÿï¼‰
          - é»˜è®¤IPï¼š192.168.1.1
          - é»˜è®¤è´¦å·ï¼šroot/password
        files: |
          artifacts/*.bin
          artifacts/*.manifest
        draft: false
